{% extends "layout.html" %}
{% block main %}
<link id="theme" rel="stylesheet" type="text/css" href="/static/stylesheets/darkblue.css" />
<div style="margin-left:5%;">
    <a href="/resources" style="color:white;text-decoration:none;">


    <title>Nebulus Planner</title>

    <style>
        table {
            font-family: 'Lato', sans-serif;
            border-collapse: collapse;
            width: 100%;
            color:white;
        }

        td {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
            position: relative;
            height:50px;
        }

        button {
            background-color: transparent;
            color: white;
            padding: 15px;
            margin-top: 10px;
            border-style:solid;
            border-color:#00bfff;
            border-width:2.5px;
            border-radius:10px;
            font-size:1.5em;
        }

        textarea {
            font-family: 'Lato', sans-serif;
            position: absolute;
            background:transparent;
            color:white;
            width: 100%;
            top: 0; left: 0; right: 0; bottom: 0;
            position: absolute;
            resize: none;
            -webkit-box-sizing: border-box; /* <=iOS4, <= Android  2.3 */
            -moz-box-sizing: border-box; /* FF1+ */
            box-sizing: border-box; /* Chrome, IE8, Opera, Safari 5.1*/
            outline:none;

            /*background-attachment: local;
              background-image:
                  linear-gradient(to right, transparent 10px, transparent 10px),
                  linear-gradient(to left, transparent 10px, transparent 10px),
                  repeating-linear-gradient(transparent, transparent 30px, #ccc 10px, #ccc 11px, transparent 31px);
               line-height: 31px;
               padding: 8px 10px;

            background-attachment: local;
            background-attachment: local;
            background-image: repeating-linear-gradient(transparent, transparent 30px, #555 10px, #555 11px transparent 30px);
            padding: 10px 10px;*/
        }

    </style>

    <h1>
        <span id="month">If the script crashes, this will be displayed.</span>
        <span style='float:right'>Digital CJ</span>
    </h1><br>

    <span id="dates"></span>

    <table id="table"></table>

    <button id="prevpage">Prev Page</button>
    <button id="nextpage" style="float:right">Next Page</button>
    <center>
        <span id="savestate" style="color:#b8b8b8;text-decoration:underline">Synced to Cloud | Last Edit was seconds ago</span><br>
        <button id="today">Today</button>
    </center>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        try {

            var d = new Date();
            var month = d.getMonth();
            var year = d.getFullYear();
            var oneWeek = 1000 * 60 * 60 * 24 * 7;
            var page = Math.floor(Date.now() / oneWeek);

            var nextPage = document.getElementById("nextpage");
            var today = document.getElementById("today");
            var prevPage = document.getElementById("prevpage");

            var saveState = document.getElementById("savestate");

            var startDate = d.getDate() - d.getDay();
            var weekDays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            var months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
            var daysInMonths = [31, d.getFullYear() % 4 == 0 ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

            var table = document.getElementById("table");

            var saveData = {};

            table.addEventListener("keyup", save);

            loadFromServer();

            nextPage.onclick = function() {
                page++;
                load(page);

                nextPage.disabled = year >= 2030 && month == 11 && startDate >= daysInMonths[month] - 7;
                prevPage.disabled = false;

                startDate += 7;
                if (startDate > daysInMonths[month]) {
                    startDate -= daysInMonths[month]
                    month++;

                    if (month > 11) {
                        month = 0;
                        year++;
                    }
                }

                changeDate();
                save();
            }

            prevPage.onclick = function() {
                page--;
                load(page);

                prevPage.disabled = year <= 1970 && month == 0 && startDate <= 7;
                nextPage.disabled = false;

                startDate -= 7;
                if (startDate < 0) {
                    month--;

                    if (month < 0) {
                        year--;
                        month = 11;
                    }

                    startDate += daysInMonths[month];
                }

                changeDate();
                save();
            }

            today.onclick = function() {
                page = Math.floor(Date.now() / oneWeek);
                load(page);
                startDate = d.getDate() - d.getDay();
                year = d.getFullYear();
                month = d.getMonth();
                changeDate();
                nextPage.disabled = false;
                prevPage.disabled = false;
            }

            document.getElementById("month").innerHTML = months[month] + " " + d.getFullYear();

            var daysRow = table.insertRow();
            for (var i = 0; i < 7; i++)
                daysRow.insertCell();

            changeDate();

            for(var i = 1; i <= 8; i++) {
                var row = table.insertRow();

                var smallCell = row.insertCell();
                smallCell.style.width = "20px";

                var textarea = document.createElement("TEXTAREA");
                textarea.innerHTML = i;
                textarea.style.padding = "15px 12px";
                textarea.style.fontsize = "1.5em";
                smallCell.appendChild(textarea);

                for (var j = 0; j < 6; j++) {
                    var cell = row.insertCell();

                    textarea = document.createElement("TEXTAREA");
                    textarea.className = "note";
                    //textarea.placeholder = "_".repeat(105);
                    cell.appendChild(textarea);
                }
            }

            function changeDate()
            {
                document.getElementById("month").innerHTML = months[month] + " " + year;

                var day;
                for (var i = 1; i < 7; i++) {
                    day = startDate + i;
                    if (day > daysInMonths[month])
                        day -= daysInMonths[month];

                    table.rows[0].cells[i].innerHTML = day.toString() + " " + weekDays[i-1];
                }

                day = startDate + 7;
                if (day > daysInMonths[month])
                    day -= daysInMonths[month];
                table.rows[0].cells[6].innerHTML += "/" + day.toString() + " Sunday";
            }

            function save()
            {
                var notes = document.getElementsByClassName("note");
                saveData[page] = {};
                for (var i = 0; i < notes.length; i++) {
                    if (notes[i].value != "")
                        saveData[page][i] = notes[i].value;
                }

                saveToServer();
            }

            function load(page)
            {
                var notes = document.getElementsByClassName("note");
                for (var i = 0; i < notes.length; i++) {
                    if (saveData[page] && saveData[page][i])
                        notes[i].value = saveData[page][i];
                    else
                        notes[i].value = "";
                }
            }

            function loadFromServer()
            {
                var request = $.ajax({
                    type: "GET",
                    url: "/getCJ"
                });

                request.done(function(data) {
                    saveData = data["savedata"];
                });

                request.fail(function (jqXHR, textStatus) {
                    alert('Error: Loading CJ Data failed. Please try again later.')
                });
            }

            function saveToServer()
            {
                var save = {};
                save["lastedited"] = new Date().toString();
                save["savedata"] = saveData;

                saveState.innerHTML = "Saving";

                var request = $.ajax({
                    type: "GET",
                    url: "/saveCJ",
                    data: JSON.stringify(save)
                });

                request.done(function (ignored) {
                    saveState.innerHTML = "Saving successful!";
                });

                request.fail(function (ignored, alsoignored) {
                    saveState.innerHTML = "Saving failed!";
                });
            }

        } catch (e) {
            alert("An error has occured:\n" + e + "\n\nStack trace:\n" + e.stack);
        }
    </script>
    <script>
        function getRandomInt(max) {
            return Math.floor(Math.random() * max);
        }

        function swapStyleSheet() {
            var sheet = "";
            var request =  $.ajax({
                type: "GET",
                url: "/getTheme"
            });
            request.done(function(data){
                document.getElementById("theme").setAttribute("href", data+"?version="+String.valueOf(getRandomInt(1000000)));
            });
            request.fail(function (jqXHR, textStatus) {
                alert('Error: Changing theme failed. Please try again later')
            });

        }
        window.onload = swapStyleSheet;
    </script>
    {% endblock %}