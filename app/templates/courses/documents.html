<!--Extend with Jinja!-->
{% extends "layout.html" %}
{% block main %}

<link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>
<div style="margin-left:10px;width:calc(100% - 280px);float:left;" id="documentPage">
    {% if course.documents|length == 0 and course.folders|length == 0 %}
    <h1 style="margin-left:20px;margin-top:20px;" class="text-2xl text-black dark:text-white">You have no documents
        or folders :(. Try creating one!</h1>
    {% endif %}

    {% for i in course.folders %}
    <br>
    <a style="width:90%;"
       class="block p-6 max-w-sm bg-white rounded-lg border border-gray-200 shadow-md hover:bg-gray-100 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700">
            <p class="font-normal text-gray-700 dark:text-gray-400" style="white-space: nowrap;  ">
                <svg style="display: inline-block;margin-right:15px;" class="w-6 h-6" fill="none"
                     stroke="{{i.color}}" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                </svg>
                <span>{{i.name}}</span></p>
        </a>
        {% endfor %}
        {% for i in course.documents %}
        <br>
        <a onclick="document.getElementById('documentPage').style.display = 'none';startFile('{{i.url}}');"
           style="width:90%;"
           class="block p-6 max-w-sm bg-white rounded-lg border border-gray-200 shadow-md hover:bg-gray-100 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700">
            <p class="font-normal text-gray-700 dark:text-gray-400" style="white-space: nowrap;  ">
                <svg style="display:inline-block;margin-right:15px;" class="w-6 h-6" fill="none" stroke="currentColor"
                     viewBox="0 0 24 24"
                     xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                <span>{{i.name}}</span></p>
        </a>
        {% endfor %}


    </div>
<div id="pdf-viewer" style="display:none;">
    <style>
        canvas {
            width: 100%;
            border: 3px solid black;
            border-radius: 10px;

        }

        .container {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            background: #121926;
            width: 90%;
            margin-left: 20px;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }


    </style>
    <script>
        // intial params
        let pdf;
        let canvas;
        let isPageRendering;
        let pageRenderingQueue = null;
        let canvasContext;
        let totalPages;
        let currentPageNum = 1;

        // events
        function startFile(link) {
            if (link.includes("pdf")) {
                document.getElementById("pdf-viewer").style.display = "block";
                startPDF(link)
            } else {
                var request = new XMLHttpRequest();
                request.open('GET', link, true);
                request.send(null);
                request.onreadystatechange = function () {
                    if (request.readyState === 4 && request.status === 200) {
                        var type = request.getResponseHeader('Content-Type');
                        if (type.indexOf("text") !== 1) {
                            document.getElementById("code_loc").innerText = request.responseText;
                        }
                    }
                }
            }
        }

        function startPDF(link) {
            isPageRendering = false;
            pageRenderingQueue = null;
            canvas = document.getElementById('pdf_canvas');
            canvasContext = canvas.getContext('2d');

            initEvents();
            initPDFRenderer(link);
        }

        function initEvents() {
            let prevPageBtn = document.getElementById('prev_page');
            let nextPageBtn = document.getElementById('next_page');
            let goToPage = document.getElementById('go_to_page');
            console.log(prevPageBtn);
            prevPageBtn.addEventListener('click', renderPreviousPage);
            console.log(nextPageBtn);
            nextPageBtn.addEventListener('click', renderNextPage);
            console.log(goToPage);
            goToPage.addEventListener('click', goToPageNum);
        }

        // init when window is loaded
        function initPDFRenderer(url) {


            // const url = 'test1.pdf'; // replace with your pdf location

            let option = {url};


            pdfjsLib.getDocument(option).promise.then(pdfData => {
                totalPages = pdfData.numPages;
                let pagesCounter = document.getElementById('total_page_num');
                pagesCounter.textContent = totalPages;
                // assigning read pdfContent to global variable
                pdf = pdfData;
                renderPage(currentPageNum);
            });
        }

        function renderPage(pageNumToRender = 1, scale = 1) {
            isPageRendering = true;
            document.getElementById('current_page_num').textContent = pageNumToRender;
            pdf.getPage(pageNumToRender).then(page => {
                document.getElementById("loader").style.display = "none";
                const viewport = page.getViewport({scale: 5});
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                let renderCtx = {canvasContext, viewport};
                page.render(renderCtx).promise.then(() => {
                    isPageRendering = false;
                    if (pageRenderingQueue !== null) { // this is to check of there is next page to be rendered in the queue
                        renderPage(pageNumToRender);
                        pageRenderingQueue = null;
                    }
                });
            });
        }

        function renderPageQueue(pageNum) {
            if (pageRenderingQueue != null) {
                pageRenderingQueue = pageNum;
            } else {
                renderPage(pageNum);
            }
        }

        function renderNextPage(ev) {
            if (currentPageNum >= totalPages) {
                currentPageNum = 0;
            }
            currentPageNum++;
            renderPageQueue(currentPageNum);
        }

        function renderPreviousPage(ev) {
            if (currentPageNum <= 1) {
                currentPageNum = (totalPages + 1);
            }
            currentPageNum--;
            renderPageQueue(currentPageNum);
        }

        function goToPageNum(ev) {
            let numberInput = document.getElementById('page_num');
            let pageNumber = parseInt(numberInput.value);
            if (pageNumber) {
                if (pageNumber <= totalPages && pageNumber >= 1) {
                    currentPageNum = pageNumber;
                    numberInput.value = "";
                    renderPageQueue(pageNumber);
                    return;
                }
            }
            numberInput.value = "";
            // alert("Enter a valide page numer");
        }
    </script>

    <div id="loader" class="text-">Loading ......</div>
    <div class="container">
        <button id="prev_page" type="button"
                class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">
            Previous Page
        </button>
        <button id="next_page" type="button"
                class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">
            Next Page
        </button>
        <span class="text-black dark:text-white">
            <span id="current_page_num"></span>
            of
            <span id="total_page_num"></span>
        </span>

        <input class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
               style="width:150px;display:inline-block;" type="text" id="page_num">
        <button id="go_to_page" type="button"
                class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">
            Go to Page
        </button>
    </div>
    <canvas id="pdf_canvas"></canvas>


    <!-- Replace pdf.js with downloaded pdf.js file -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
</div>
<div id=code-viewer" style="display:none;">
    <script>
        // // load the library and ALL languages
        // hljs = require('highlight.js');
        // html = hljs.highlightAuto('<h1>Hello World!</h1>').value
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre code').forEach((el) => {
                hljs.highlightElement(el);
            });
        });
        setInterval(function () {
            document.querySelectorAll('pre code').forEach((el) => {
                hljs.highlightElement(el);
            });
        }, 5000)
    </script>
    <pre onClick="this.contentEditable='true';" style="width:80%;border-radius:10px;margin-left:10%;">
        <code id="code_loc" onClick="this.contentEditable='true';"
              style="border-radius:10px; background:#1F2937;color:white;"
              class="language-python">
        </code>
    </pre>
    <style>
        .hljs {
            display: block;
            overflow-x: auto;
            padding: .5em;
            background: #1d1f21
        }

        .hljs,
        .hljs-subst {
            color: #c5c8c6
        }

        .hljs-comment {
            color: #888
        }

        .hljs-attribute,
        .hljs-doctag,
        .hljs-keyword,
        .hljs-meta-keyword,
        .hljs-name,
        .hljs-selector-tag {
            font-weight: 700;
            color: #FF7B72;
        }

        .hljs-tag,
        .hljs-name {
            color: #79DC83 !important;

        }

        .hljs-attr {
            color: #78C1FF !important;
        }


        .hljs-deletion,
        .hljs-number,
        .hljs-quote,
        .hljs-selector-class,
        .hljs-selector-id,
        .hljs-string,
        .hljs-template-tag,
        .hljs-type {
            color: #9ECFF6;
        }

        .hljs-section,
        .hljs-title {
            color: #99cc99;
            font-weight: 700;
        }

        .hljs-link,
        .hljs-regexp,
        .hljs-selector-attr,
        .hljs-selector-pseudo,
        .hljs-symbol,
        .hljs-template-variable,
        .hljs-variable {
            color: #bc6060
        }

        .hljs-literal {
            color: #78a960
        }

        .hljs-addition,
        .hljs-built_in,
        .hljs-bullet,
        .hljs-code {
            color: #D1A8FE;
        }

        .hljs-meta {
            color: #1f7199
        }

        .hljs-meta-string {
            color: #9ECFF6
        }

        .hljs-emphasis {
            font-style: italic
        }

        .hljs-strong {
            font-weight: 700
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        code::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        code {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }


    </style>
</div>


{% endblock %}