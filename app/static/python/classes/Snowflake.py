import datetime
import time

from mongoengine import Document, StringField

from app.static.python.utils.snowflake_generator import make_snowflake, melt

lms_choices = (
    "Nebulus",
    "Canvas",
    "Google Classroom",
    "Microsoft Teams",
    "Schoology",
    "Moodle",
    "Blackboard Learn",
    "Other",
)


# In graphql, we use the snowflake as the unique identifier for a node. The snowflake is represented as a String.


class Snowflake(Document):
    meta = {"allow_inheritance": True, "abstract": True}
    id = StringField(
        default=lambda: str(make_snowflake(time.time() * 1000, 1, 0, 0)),
        primary_key=True,
    )
    imported_from = StringField(default="Nebulus", choices=lms_choices)
    imported_id = StringField(default=None)

    def get_timestamp(self) -> datetime.datetime:
        return datetime.datetime.fromtimestamp(melt(int(self.id))[0] / 1000)

    def __eq__(self, other):
        return self.id == other.id and self._cls == other._cls

    def __hash__(self):
        return hash(" ".join(map(str, self._fields_ordered)))
